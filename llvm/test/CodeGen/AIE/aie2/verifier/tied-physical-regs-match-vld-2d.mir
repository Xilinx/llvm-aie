#
# This file is licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
#
# (c) Copyright 2023-2024 Advanced Micro Devices, Inc. or its affiliates
# RUN: not --crash llc -mtriple=aie2 -run-pass machineverifier -o /dev/null %s 2>&1 | FileCheck %s

# This test ensures that the Machine Verifier detects tied physical registers
# that don't match.

---
name:            tied_ok
alignment:       16
body:             |
  bb.0 (align 16):
    $wl0, $p0, $dc0 = VLDA_2D_dmw_lda_w $p0, $d0
    $amll0, $p0, $dc0 = VLDA_2D_dmw_lda_am $p0, $d0
    $bmh0, $p0, $dc4 = VLDA_2D_UPS_S32_D16 $s0, $p0, $d4, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml2, $p2, $dc3 = VLDA_2D_UPS_S32_S16 $s1, $p2, $d3, implicit-def $srups_of, implicit $crsat
    $bmh5, $p3, $dc2 = VLDA_2D_UPS_S64_D32 $s2, $p3, $d2, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml7, $p5, $dc0 = VLDA_2D_UPS_S64_S32 $s3, $p5, $d0, implicit-def $srups_of, implicit $crsat
    $cm0, $p0, $dc4 = VLDA_2D_UPS_S32_D8  $s0, $p0, $d4, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $cm2, $p2, $dc3 = VLDA_2D_UPS_S32_S8  $s1, $p2, $d3, implicit-def $srups_of, implicit $crsat
    $cm5, $p3, $dc2 = VLDA_2D_UPS_S64_S16 $s2, $p3, $d2, implicit-def $srups_of, implicit $crsat
    $cm7, $p5, $dc0 = VLDA_2D_UPS_S64_D16 $s3, $p5, $d0, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $wl0, $p0, $dc0 = VLDB_2D $p0, $d0
    $bml0, $p0, $dc0 = VLDA_2D_CONV_FP32_BF16 $p0, $d0
    $x0, $p0, $dc4 = VLDB_2D_UNPACK_S8_S4 $p0, $d4
    $x2, $p2, $dc3 = VLDB_2D_UNPACK_S16_S8 $p2, $d3
    $x5, $p3, $dc2 = VLDB_2D_UNPACK_D8_D4 $p3, $d2, implicit $crunpacksign
    $x7, $p5, $dc0 = VLDB_2D_UNPACK_D16_D8 $p5, $d0, implicit $crunpacksign
...

# Virtual registers are not required to be tied.
---
name:            virtual_ok
alignment:       16
body:             |
  bb.0 (align 16):
    %0:ep = COPY $p0
    %10:ed = COPY $d0
    $wl0, %20:ep, %21:edc = VLDA_2D_dmw_lda_w %0, %10
    $amll0, %30:ep, %31:edc = VLDA_2D_dmw_lda_am %0, %10
    $bmh0, %40:ep, %41:edc = VLDA_2D_UPS_S32_D16 $s0, %0, %10, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml2, %50:ep, %51:edc = VLDA_2D_UPS_S32_S16 $s1, %0, %10, implicit-def $srups_of, implicit $crsat
    $bmh5, %60:ep, %61:edc = VLDA_2D_UPS_S64_D32 $s2, %0, %10, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml7, %70:ep, %71:edc = VLDA_2D_UPS_S64_S32 $s3, %0, %10, implicit-def $srups_of, implicit $crsat
    $cm0, %80:ep, %81:edc = VLDA_2D_UPS_S32_D8  $s0, %0, %10, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $cm2, %90:ep, %91:edc = VLDA_2D_UPS_S32_S8  $s1, %0, %10, implicit-def $srups_of, implicit $crsat
    $cm5, %100:ep, %101:edc = VLDA_2D_UPS_S64_S16 $s2, %0, %10, implicit-def $srups_of, implicit $crsat
    $cm7, %110:ep, %111:edc = VLDA_2D_UPS_S64_D16 $s3, %0, %10, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $wl0, %120:ep, %121:edc = VLDB_2D %0, %10
    $bml0, %130:ep, %131:edc = VLDA_2D_CONV_FP32_BF16 %0, %10
    $x0, %140:ep, %141:edc = VLDB_2D_UNPACK_S8_S4 %0, %10
    $x2, %150:ep, %151:edc = VLDB_2D_UNPACK_S16_S8 %0, %10
    $x5, %160:ep, %161:edc = VLDB_2D_UNPACK_D8_D4 %0, %10, implicit $crunpacksign
    $x7, %170:ep, %171:edc = VLDB_2D_UNPACK_D16_D8 %0, %10, implicit $crunpacksign
...

---
name:            tied_nok
alignment:       16
body:             |
  bb.0 (align 16):
    ; CHECK-NOT: Bad machine code
    ; CHECK-COUNT-16: Bad machine code: Tied physical registers must match
    $wl0, $p0, $dc1 = VLDA_2D_dmw_lda_w $p0, $d0
    $amll0, $p0, $dc2 = VLDA_2D_dmw_lda_am $p0, $d0
    $bmh0, $p0, $dc3 = VLDA_2D_UPS_S32_D16 $s0, $p0, $d4, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml2, $p2, $dc4 = VLDA_2D_UPS_S32_S16 $s1, $p2, $d5, implicit-def $srups_of, implicit $crsat
    $bmh5, $p3, $dc5 = VLDA_2D_UPS_S64_D32 $s2, $p3, $d6, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml7, $p5, $dc6 = VLDA_2D_UPS_S64_S32 $s3, $p5, $d7, implicit-def $srups_of, implicit $crsat
    $cm0, $p0, $dc7 = VLDA_2D_UPS_S32_D8  $s0, $p0, $d6, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $cm2, $p2, $dc6 = VLDA_2D_UPS_S32_S8  $s1, $p2, $d5, implicit-def $srups_of, implicit $crsat
    $cm5, $p3, $dc5 = VLDA_2D_UPS_S64_S16 $s2, $p3, $d4, implicit-def $srups_of, implicit $crsat
    $cm7, $p5, $dc4 = VLDA_2D_UPS_S64_D16 $s3, $p5, $d3, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $wl0, $p0, $dc3 = VLDB_2D $p0, $d0
    $bml0, $p0, $dc2 = VLDA_2D_CONV_FP32_BF16 $p0, $d0
    $x0, $p0, $dc7 = VLDB_2D_UNPACK_S8_S4 $p0, $d6
    $x2, $p2, $dc6 = VLDB_2D_UNPACK_S16_S8 $p2, $d5
    $x5, $p3, $dc5 = VLDB_2D_UNPACK_D8_D4 $p3, $d4, implicit $crunpacksign
    $x7, $p5, $dc4 = VLDB_2D_UNPACK_D16_D8 $p5, $d3, implicit $crunpacksign

    ; Below instructions have hasExtraSrcRegAllocReq and hasExtraDefRegAllocReq attributes
    ; which essentially bypass the register flags. The renamable attributes
    ; below should trigger no verification error.
    ; CHECK-NOT: Bad machine code
    $wl0, $p0, renamable $dc1 = VLDA_2D_dmw_lda_w $p0, renamable $d1
    $amll0, $p0, renamable $dc2 = VLDA_2D_dmw_lda_am $p0, renamable $d2
    $bmh0, $p0, renamable $dc4 = VLDA_2D_UPS_S32_D16 $s0, $p0, renamable $d4, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml2, $p2, renamable $dc3 = VLDA_2D_UPS_S32_S16 $s1, $p2, renamable $d3, implicit-def $srups_of, implicit $crsat
    $bmh5, $p3, renamable $dc2 = VLDA_2D_UPS_S64_D32 $s2, $p3, renamable $d2, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $bml7, $p5, renamable $dc0 = VLDA_2D_UPS_S64_S32 $s3, $p5, renamable $d0, implicit-def $srups_of, implicit $crsat
    $cm0, $p0, renamable $dc4 = VLDA_2D_UPS_S32_D8  $s0, $p0, renamable $d4, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $cm2, $p2, renamable $dc3 = VLDA_2D_UPS_S32_S8  $s1, $p2, renamable $d3, implicit-def $srups_of, implicit $crsat
    $cm5, $p3, renamable $dc2 = VLDA_2D_UPS_S64_S16 $s2, $p3, renamable $d2, implicit-def $srups_of, implicit $crsat
    $cm7, $p5, renamable $dc0 = VLDA_2D_UPS_S64_D16 $s3, $p5, renamable $d0, implicit-def $srups_of, implicit $crsat, implicit $crupssign
    $wl0, $p0, renamable $dc3 = VLDB_2D $p0, renamable $d3
    $bml0, $p0, renamable $dc2 = VLDA_2D_CONV_FP32_BF16 $p0, renamable $d2
    $x0, $p0, renamable $dc4 = VLDB_2D_UNPACK_S8_S4 $p0, renamable $d4
    $x2, $p2, renamable $dc3 = VLDB_2D_UNPACK_S16_S8 $p2, renamable $d3
    $x5, $p3, renamable $dc2 = VLDB_2D_UNPACK_D8_D4 $p3, renamable $d2, implicit $crunpacksign
    $x7, $p5, renamable $dc0 = VLDB_2D_UNPACK_D16_D8 $p5, renamable $d0, implicit $crunpacksign
...
