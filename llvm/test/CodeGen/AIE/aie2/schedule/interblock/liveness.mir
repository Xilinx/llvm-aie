# This file is licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
#
# (c) Copyright 2024 Advanced Micro Devices, Inc. or its affiliates

# RUN: llc --mtriple=aie2 -verify-machineinstrs --run-pass=postmisched --issue-limit=1 -debug-only=machine-scheduler %s -o - 2>%t.log
# RUN: cat %t.log | FileCheck %s --check-prefix=CHECK-LIVENESS
# REQUIRES: asserts

# These tests verify liveouts of every MachineBasicBlock in MachineFunction and 
# liveins of every Region in MachineBasicBlock.

#     bb.0
#     /  \
# bb.1    bb.2
#     \  /
#     bb.3
# srcarry is found not to be live, because there are no reads of it in the function
---
name:            liveness_branch
alignment:       16
tracksRegLiveness: true
body:             |
  ; CHECK-LIVENESS-LABEL: liveness_branch:BB0 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r2 $r4 $r5 $r3
  ; CHECK-LIVENESS-NEXT: liveness_branch:BB1 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r5 $r2
  ; CHECK-LIVENESS-NEXT: liveness_branch:BB2 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r5 $r2
  ; CHECK-LIVENESS-NEXT: liveness_branch:BB3 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: (empty)

  bb.0:
    liveins: $r1, $r2, $r5
    successors: %bb.1, %bb.2
    $r0 = nsw ADD $r1, $r2, implicit-def $srcarry
    $r3 = nsw ADD $r0, $r1, implicit-def $srcarry
    $r4 = nsw ADC $r3, $r5, implicit-def $srcarry, implicit $srcarry
    $r7 = MOV_mv_scl $srcarry
    JNZ $r7, %bb.2
    DelayedSchedBarrier
  bb.1:
    successors: %bb.3
    liveins: $r2, $r4
    $r5 = nsw ADD $r2, $r4, implicit-def $srcarry
    J_jump_imm %bb.3
    DelayedSchedBarrier
  bb.2:
    successors: %bb.3
    liveins: $r3, $r4
    $r1 = nsw ADD $r3, $r4, implicit-def $srcarry
  bb.3:
    liveins: $r2, $r5, $r6
    $r1 = nsw ADD $r5, $r2, implicit-def $srcarry
    RET implicit $lr
    DelayedSchedBarrier implicit $r1 
...

#     bb.0
#       |
#     bb.1* (self loop)
#       | 
#     bb.2
# srfpflags is found not to be live, because there are no reads of it in the function
---
name:            liveness_selfloop
alignment:       16
tracksRegLiveness: true
body:             |
  ; CHECK-LIVENESS-LABEL: liveness_selfloop:BB0 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r1 $amlh2 $amll2 $crfpmask $bml2 $bml1 $amll1 $amlh1 $bml0 $amll0 $amlh0
  ; CHECK-LIVENESS-NEXT: liveness_selfloop:BB1 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r1 $amlh2 $amll2 $crfpmask $bml2 $bml1 $amll1 $amlh1 $bml0 $amll0 $amlh0
  ; CHECK-LIVENESS-NEXT: liveness_selfloop:BB2 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: (empty)

  bb.0:
    liveins: $bml0, $bml1, $r0
    successors: %bb.1
    $bml2 = VADD_F $bml0, $bml1, $r0, implicit-def $srfpflags,  implicit $crfpmask
    $r1 = MOV_mv_scl $r0
  bb.1:
    liveins: $bml0, $bml1, $bml2, $r1
    successors: %bb.1, %bb.2
    $bml3 = VADD_F $bml0, $bml2, $r1, implicit-def $srfpflags,  implicit $crfpmask
    $bml1 = VADD_F $bml1, $bml3, $r1, implicit-def $srfpflags,  implicit $crfpmask
    $bml2 = VADD_F $bml1, $bml2, $r1, implicit-def $srfpflags,  implicit $crfpmask
    $r1 = ADD_add_r_ri $r1, -1, implicit-def $srcarry
    JNZ $r1, %bb.1
    DelayedSchedBarrier
  bb.2:
    liveins: $bml2
    RET implicit $lr
    DelayedSchedBarrier implicit $bml2
...

#     bb.0-----*
#     /  \     |
# bb.1    bb.2 |
#     \  /     |
#     bb.3-----*
#       |
#     bb.4
# srcarry is found not to be liveouts, because there are no reads across the BB 
# i.e. every BB has its own definition of srcarry and read after that.
---
name:            liveness_loop
alignment:       16
tracksRegLiveness: true
body:             |
  ; CHECK-LIVENESS-LABEL: liveness_loop:BB0 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $r6 $lr $r2 $r4 $r5 $r3
  ; CHECK-LIVENESS-NEXT: liveness_loop:BB1 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $r6 $lr $r5 $r2
  ; CHECK-LIVENESS-NEXT: liveness_loop:BB2 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $r6 $lr $r5 $r2
  ; CHECK-LIVENESS-NEXT: liveness_loop:BB3 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $r6 $lr $r2 $r5 $r1
  ; CHECK-LIVENESS-NEXT: liveness_loop:BB4 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: (empty)

  bb.0:
    liveins: $r1, $r2, $r5, $r6
    successors: %bb.1, %bb.2
    $r0 = nsw ADD $r1, $r2, implicit-def $srcarry
    $r3 = nsw ADD $r0, $r1, implicit-def $srcarry
    $r4 = nsw ADC $r3, $r5, implicit-def $srcarry, implicit $srcarry
    $r7 = MOV_mv_scl $srcarry
    JNZ $r7, %bb.2
    DelayedSchedBarrier
  bb.1:
    successors: %bb.3
    liveins: $r2, $r4
    $r5 = nsw ADD $r2, $r4, implicit-def $srcarry
    J_jump_imm %bb.3
    DelayedSchedBarrier
  bb.2:
    successors: %bb.3
    liveins: $r3, $r4
    $r1 = nsw ADD $r3, $r4, implicit-def $srcarry
  bb.3:
    successors: %bb.0, %bb.4
    liveins: $r2, $r5, $r6
    $r1 = nsw ADD $r5, $r2, implicit-def $srcarry
    $r6 = ADD_add_r_ri $r6, -1, implicit-def $srcarry
    JNZ $r6, %bb.0
    DelayedSchedBarrier
  bb.4:
    liveins: $r1
    RET implicit $lr
    DelayedSchedBarrier implicit $r1 
...

#     bb.0
#       |
#     bb.1-------*
#       |        |
#     bb.2-----* |
#     /  \     | |
# bb.3    bb.4 | |
#     \  /     | |
#     bb.5-----* |
#       |        |
#     bb.6-------*
#       |
#     bb.7
# This version has reads of srcarry across the BB, so srcarry is visible in LiveOuts.
---
name:            liveness_nested_loop
alignment:       16
tracksRegLiveness: true
body:             |
  ; CHECK-LIVENESS-LABEL: liveness_nested_loop:BB0 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r4 $r6 $r8 $r2 $r0 $r1
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB1 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r3 $r1 $r8 $r2 $r4 $r0 $r6 $srcarry
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB2 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r3 $r1 $r8 $r2 $r4 $r0 $r6 $srcarry
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB3 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r3 $r1 $r8 $r2 $r4 $r0 $r6 $srcarry
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB4 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r3 $r1 $r8 $r2 $r4 $r0 $r6 $srcarry
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB5 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r3 $r1 $r8 $r2 $r4 $r0 $r6 $srcarry $r9
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB6 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: $lr $r4 $r6 $r8 $r2 $r0 $r1 $r3 $r9 $srcarry
  ; CHECK-LIVENESS-NEXT: liveness_nested_loop:BB7 LiveOuts
  ; CHECK-LIVENESS-NEXT:   Live Registers: (empty)
  
  bb.0:
    successors: %bb.1
    liveins: $r1, $r2
    $r0 = nsw ADD $r1, $r2, implicit-def $srcarry
  bb.1:
    successors: %bb.2
    liveins: $r0, $r1
    $r3 = nsw ADD $r0, $r1, implicit-def $srcarry
  bb.2:
    successors: %bb.3, %bb.4
    $r7 = MOV_mv_scl $srcarry
    JNZ $r7, %bb.4
    DelayedSchedBarrier
  bb.3:
    successors: %bb.5
    liveins: $r2, $r4
    $r5 = nsw ADD $r2, $r4, implicit-def $srcarry
    J_jump_imm %bb.5
    DelayedSchedBarrier
  bb.4:
    successors: %bb.5
    $r1 = MOV_mv_scl $srcarry
  bb.5:
    successors: %bb.2, %bb.6
    liveins: $r6
    $r9 = MOV_mv_scl $srcarry
    $r6 = ADD_add_r_ri $r6, -1, implicit-def $srcarry
    JNZ $r6, %bb.2
    DelayedSchedBarrier
  bb.6:
    successors: %bb.1, %bb.7
    liveins: $r8
    $r8 = ADD_add_r_ri $r8, -2, implicit-def $srcarry
    JNZ $r8, %bb.1
    DelayedSchedBarrier
  bb.7:
    liveins: $r3, $r9
    $r4 = nsw ADC $r3, $r9, implicit-def $srcarry, implicit $srcarry
    RET implicit $lr
    DelayedSchedBarrier implicit $r4
...
